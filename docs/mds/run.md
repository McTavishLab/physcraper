
The easiest way to run Physcraper is using the command line tools. This way, you can directly specify arguments.
A configuration file will be written down for the sake of reproducibility.

## Example Physcraper runs from the command line

### Starting with only an OpenTree study and tree id

As input, you will minimally need a study and tree ids from a tree uploaded to the OpenTree website (https://tree.opentreeoflife.org/curator). The `--treebase` flag (or `-tb`) will automatically download an alignment for that tree from TreeBASE.


    physcraper_run.py [-s OPENTREE_STUDY_ID] [-t OPENTREE_TREE_ID] [-tb] [-o OUTPUT]


e.g.,


    physcraper_run.py -s pg_55 -t tree5864 -tb -o pg_55_web


The output files generated by this example run are stored in "docs/examples/pg_55_web"

### Starting with an OpenTree study and tree id and an alignment

Alternatively, you can provide the gene alignment that you want to update using the `-a` command:


    physcraper_run.py [-s OPENTREE_STUDY_ID] [-t OPENTREE_TREE_ID] [-o OUTPUT] [-a ALIGNMENT] [-as ALIGNMENT_SCHEMA]



For example, to update a tree from [Crous et al. 2012](https://tree.opentreeoflife.org/curator/study/view/ot_350/?tab=home&tree=Tr53296) using an alignment already downloaded from TreeBASE, you can do:


    physcraper_run.py -s ot_350 -t Tr53297 -a docs/examples/inputdata/ot_350Tr53297.aln -as "nexus" -o ot_350


### Starting with your own tree

If the tree you want to update is not posted to the OpenTree website, you need to match
the labels on your tree to taxa using the [OpenTree Bulk Taxonomic Name Resolution Service](https://tree.opentreeoflife.org/curator/tnrs/). Download your matched names, unzip the folder, and pass the "json" file that is output from the OpenTree Bulk TNRS tool as `--taxon_info` or `-ti` argument:


    physcraper_run.py [-tf TREE_FILE] [-tfs TREEFILE_SCHEMA] [-a ALIGNMENT] [-as ALIGNMENT_SCHEMA] [-ti TAXON_INFO_JSONFILE]  [-o OUTPUT]


e.g.,


    physcraper_run.py -tf tests/data/tiny_test_example/test.tre -tfs newick -a tests/data/tiny_test_example/test.fas  -as fasta --taxon_info tests/data/tiny_test_example/main.json -o owndata


### Checking the inputs before a full run

Use the flag `-no_est` to simply download a tree from OpenTree and the corresponding alignment from TreeBASE.
This will not run the BLAST and tree estimation steps:

    physcraper_run.py -s pg_55 -t tree5864 -tb -no_est -o pg55_C


To initiate a full Physcraper run from that tree and alignment, simply remove the `-no_est` flag.
It will re-load the inputs from the specified output directory and will use your same config settings that are automatically written out to "OUTPUT_run.config".

The `-re` flag will re-run a Physcraper cycle on a given output directory.
If the initial or previous run completed, it will use the final output tree and alignment as input.
If the run was not completed, it will reload the original input files.


    physcraper_run.py -re pg_55_C -o pg_55_C


You can also re-run with a different configuration file:

    physcraper_run.py -re  pg_55_C/ -c alt_config -o  pg_55_D



## Configuration parameters


To see all the configuration parameters, use `physcraper_run.py -h`.

The configuration parameters may be set in a configuration file, and then passed into the analysis run. See file "example.config" for an example.

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-c <var>FILE_NAME</var></span>, <span class="option">--configfile <var>FILE_NAME</var></span></kbd></dt>
<dd><p>Specifies the name (and path) to the configuration file.</p>
</dd>
</dl>
</div></blockquote>


If a config file input is combined with command line configuration parameters, the command line values will override those in the configuration file.

The configuration settings for the current run are written to standard out, and saved in the
output directory as "run.config", e.g.,

    [blast]
    Entrez.email = None
    e_value_thresh = 1e-05
    hitlist_size = 20
    location = local
    localblastdb = /home/projects/ncbi/localblastdb/
    url_base = None
    num_threads = 8
    delay = 90
    [physcraper]
    spp_threshold = 3
    seq_len_perc = 0.8
    trim_perc = 0.8
    min_len = 0.8
    max_len = 1.2
    taxonomy_path = /home/projects/physcraper/taxonomy


### Input Data


Tree information (required):

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-s <var>OPENTREE_STUDY_ID</var></span>, <span class="option">--study_id <var>OPENTREE_STUDY_ID</var></span></kbd></dt>
<dd><p>Indicates the OpenTree study id.</p>
</dd>
<dt><kbd><span class="option">-t <var>OPENTREE_TREE_ID</var></span>, <span class="option">--tree_id <var>OPENTREE_TREE_ID</var></span></kbd></dt>
<dd><p>Indicates the OpenTree tree id.</p>
</dd>
</dl>
</div></blockquote>

OR

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-tf <var>TREE_FILE</var></span>, <span class="option">--tree_file <var>TREE_FILE</var></span></kbd></dt>
<dd><p>Indicates the name (and path) to a tree file.</p>
</dd>
<dt><kbd><span class="option">-tfs <var>{newick,nexus}</var></span>, <span class="option">--tree_schema <var>{newick,nexus}</var></span></kbd></dt>
<dd><p>Specifies the tree file format schema, one of newick or newus.</p>
</dd>
<dt><kbd><span class="option">-ti <var>FILE_NAME</var></span>, <span class="option">--taxon_info <var>FILE_NAME</var></span></kbd></dt>
<dd><p>Indicates the name (and path) of a taxon info file from an OpenTree TNRS run.</p>
</dd>
</dl></div>
</blockquote>


Alignment information (required):

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-a <var>ALIGNMENT_FILE</var></span>, <span class="option">--alignment <var>ALIGNMENT_FILE</var></span></kbd></dt>
<dd><p>Indicates the name and path to alignment file.</p>
</dd>
<dt><kbd><span class="option">-as <var>{fasta,nexus}</var></span>, <span class="option">--aln_schema <var>{fasta,nexus}</var></span></kbd></dt>
<dd><p>Specifies the alignment schema, one of fasta or nexus.</p>
</dd>
</dl>
</div></blockquote>


OR

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-tb </span>, <span class="option">--treebase </span></kbd></dt>
<dd><p>Downloads alignment from TreeBASE.</p>
</dd>
</dl>
</div></blockquote>

<br/>

Tree and alignment information are required.
After an analysis has been run, they can be reloaded from a directory from a previous run.

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-re <var>RELOAD_FILES</var></span>, <span class="option">--reload_files <var>RELOAD_FILES</var></span></kbd></dt>
<dd><p>Reloads files and configuration from the output directory specified in <code class="docutils literal notranslate"><span class="pre">-o, --output</span></code>.
</p></dd>
</dl></div>
</blockquote>


REQUIRED:

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-o <var>OUTPUT_DIR</var></span>, <span class="option">--output <var>OUTPUT_DIR</var></span></kbd></dt>
<dd><p>Specifies the directory (and path) to output directory.</p>
</dd>
</dl>
</div></blockquote>


Optional:

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-st <var>SEARCH_TAXON</var></span>, <span class="option">--search_taxon <var>SEARCH_TAXON</var></span></kbd></dt>
<dd><p>Specifies the taxonomic id to constrain the BLAST search. Format  <code class="docutils literal notranslate"><span class="pre">ott:123</span></code> or
<code class="docutils literal notranslate"><span class="pre">ncbi:123</span></code>.
By default, it will use the ingroup of the tree from OpenTree, or the MRCA of all tips, if the former is not specified.
</p></dd>
</dl></div>
</blockquote>


### Blast search parameters

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-e <var>EMAIL</var></span>, <span class="option">--email <var>EMAIL</var></span></kbd></dt>
<dd><p>An email address for BLAST searches.</p>
</dd>
<dt><kbd><span class="option">-r </span>, <span class="option">--repeat </span></kbd></dt>
<dd><p>Repeats a BLAST search until no more sequences are found.</p>
<dt><kbd><span class="option">-ev <var>E-VALUE</var></span>, <span class="option">--eval <var>E-VALUE</var></span></kbd></dt>
<dd><p>Specifies a blast e-value cutoff.</p>
</dd>
<dt><kbd><span class="option">-hl <var>HITLIST_LENGTH</var></span>, <span class="option">--hitlist_len <var>HITLIST_LENGTH</var></span></kbd></dt>
<dd><p>Specifies the number of BLAST searches to save per taxon.</p>
</dd>
</dl></div>
</blockquote>

<br/>

You can use a local BLAST database.
To setup see [Local Databases section](https://physcraper.readthedocs.io/en/main/install.html#local-databases) of this documentation.

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-db <var>BLAST_DB</var></span>, <span class="option">--blast_db <var>BLAST_DB</var></span></kbd></dt>
<dd><p>Specifies the local download of a BLAST database.</p>
</dd>
<dt><kbd><span class="option">-nt <var>NUM_THREADS</var></span>, <span class="option">--num_threads <var>NUM_THREADS</var></span></kbd></dt>
<dd><p>Specifies the number of threads to use in processing.</p>
</dd>
</dl></div>
</blockquote>

<br/>

You can use your own BLAST database, for example set up on an AWS server.


### Sequence filtering parameters


<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-tp <var>TRIM_PERC</var></span>, <span class="option">--trim_perc <var>TRIM_PERC</var></span></kbd></dt>
<dd><p>Minimum percentage of sequences end of alignments.</p>
</dd>
<dt><kbd><span class="option">-rlmax <var>RELATIVE_LENGTH_MAX</var></span>, <span class="option">--relative_length_max <var>RELATIVE_LENGTH_MAX</var></span></kbd></dt>
<dd><p>Maximum relative length of added sequences, compared to input
alignment length (BLAST matches not within length cutoffs are stored in "outputs/seqlen_mismatch.txt").</p>
</dd>
<dt><kbd><span class="option">-rlmin <var>RELATIVE_LENGTH_MIN</var></span>, <span class="option">--relative_length_min <var>RELATIVE_LENGTH_MIN</var></span></kbd></dt>
<dd><p>Minimum relative length of added sequences, compared to input
alignment length (BLAST matches not within length cutoffs are stored in "outputs/seqlen_mismatch.txt").</p>
</dd>
<dt><kbd><span class="option">-spn <var>SPECIES_NUMBER</var></span>, <span class="option">--species_number <var>SPECIES_NUMBER</var></span></kbd></dt>
<dd><p>Maximum number of sequences to include per species.</p>
</dd>
<dt><kbd><span class="option">-de <var>DELAY</var></span>, <span class="option">--delay <var>DELAY</var></span></kbd></dt>
<dd><p>How much time to wait before blasting the same sequence again.</p>
</dd>
</dl></div>
</blockquote>

<br/>

### Tree search parameters

<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-no_est </span>, <span class="option">--no_estimate_tree </span></kbd></dt>
<dd><p>Does not estimate the tree, just gathers the sequences and aligns them.</p>
</dd>
<dt><kbd><span class="option">-bs <var>BOOTSTRAP_REPS</var></span>, <span class="option">--bootstrap_reps <var>BOOTSTRAP_REPS</var></span></kbd></dt>
<dd><p>Number of bootstrap repetitions.</p>
</dd>
</dl></div>
</blockquote>

<br/>


### Internal arguments


<blockquote>
<div><dl class="option-list">
<dt><kbd><span class="option">-tx <var>TAXONOMY</var></span>, <span class="option">--taxonomy <var>TAXONOMY</var></span></kbd></dt>
<dd><p>A path to the OpenTree Taxonomy (OTT) database.</p>
</dd>
</dl></div>
</blockquote>
